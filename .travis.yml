language: cpp
dist: bionic
os: linux
sudo: required

cache:
  - directories:
      - $HOME/.cache

common_sources: &all_sources
  - sourceline: "ppa:ubuntu-toolchain-r/test"
  - sourceline: "deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic main"
    key_url: "https://apt.llvm.org/llvm-snapshot.gpg.key"

jobs:
  include:
    - os: linux
      name: "GCC 8 / GCC 10 / LLVM 11 @ Ubuntu"
      compiler: gcc
      addons: &clang100
        apt:
          packages:
            - g++-8
            - gcc-8
            - gcc-10
            - g++-10
            - llvm-11-dev
            - libclang-11-dev
            - clang-format-11
            - clang-tidy-11
            - doxygen
            - lcov
            - graphviz # for dot package Doxygen
          sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-bionic-11
            - sourceline: "deb http://apt.llvm.org/bionic/ llvm-toolchain-bionic-11 main"
              key_url: "https://apt.llvm.org/llvm-snapshot.gpg.key"
      env: COMPILER='g++-8' COVERAGE='Yes'

install:
  # Install into cache folder (build binaries + headers only, no sources and do NOT build there)
  - mkdir -p $HOME/.cache

script:
  # Give permissions to script
  - sudo chmod +x build.sh
  # Building project and perform testing
  - sudo -E env "PATH=$PATH" ./build.sh testing
after_success:
  - cd build
  # Create lcov report: capture coverage info
  - lcov --directory . --capture --output-file coverage.info
  # filter out system and extra files.
  # To also not include test code in coverage add them with full path to the patterns: '*/tests/*'
  - lcov --remove coverage.info '/usr/*' "${HOME}"'/.cache/*' --output-file coverage.info
  # output coverage data for debugging (optional)
  - lcov --list coverage.info
  # Uploading to CodeCov
  # '-f' specifies file(s) to use and disables manual coverage gathering and
  # file search which has already been done above
  # URL: https://codecov.io/gh/markoshorro/MACVETH/branch/develop
  - bash <(curl -s https://codecov.io/bash) -t 43267e87-5aeb-41fd-b0c9-d7c3d2e2237a -f coverage.info || echo "Codecov didnot collect coverage reports"

notifications:
  email:
    - marcos.horro@udc.es
